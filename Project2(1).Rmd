---
title: "Project 2"
author: "Lily Li Bruce Shao"
date: "2021/11/7"
output: html_document
---
## Import the data
```{r}
framingham <- read.csv("C:/Users/zishan/Desktop/framingham.csv") 
framingham <- na.omit(framingham)
colnames(framingham)
```
# Data Cleaning
### We have insufficient information about the education, so we delete the thrid column of data
### The prevalent heart stroke category contains very imbalanced number of cases that we think it is not enough to represent the group (after omitting the incomplete information rows, only one patient once had prevalent stroke), so we delete the column 7.
```{r}
framingham = framingham[, -c(3), -c(7)]
```

# Exploratory Data Analysis
### In this part, we will use mosaic plot, sid-byside box plots, and empirical logit plot to determine if there is a linear relationship exist between the response variable prevalentHyp and the predictor
### Import the package "ggplot2"
```{r}
library(ggplot2)
```

### Comparing the prevalentHyp and male using the mosaic plot
```{r}
table1<-table(framingham$prevalentHyp, framingham$male)
mosaicplot(table1, xlab="male ", ylab=" prevalentHyp")
```
### Comment: the proportion of two categories are same, indicating that there is a no relation between the gender and the prevalentHyp. We should drop male as a predictor in the model.

### prevalentHyp vs age
```{r}
ggplot(framingham, aes(x = age, y = as.factor(prevalentHyp)) )+ 
  geom_boxplot() + 
  labs(title = "prevalentHyp v.s. age", 
       x = "age", y = "prevalentHyp") 
```
### Comment: the side-byside box plot shows that those who have hypertensive have evidently higher average age than those who is not, so there is a relatively strong relation between the prevalentHyp and age.

### Logit plot
```{r}
emplogit(y = framingham$prevalentHyp, x = framingham$age, binsize = 200, 
         xlab = "age", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is a linear relation between the age and TenYearCHD, so no transformation needed. Therefore, the variable age should be added in the model.


### Compare currentSmoker and prevalentHyp
```{r}
table1<-table(framingham$prevalentHyp, framingham$currentSmoker)
mosaicplot(table1, xlab= "currentSmoker", ylab= "prevalentHyp")
```
### Comment: the proportion of the hypertensive differs for smoker and nonsmokers, this means the currentSmoker has a relation with the prevalentHyp.

### Compare cigsPerDay and prevalentHyp
```{r}
ggplot(framingham, aes(x = cigsPerDay, y = as.factor(prevalentHyp)) )+ 
  geom_boxplot() + 
  labs(title = "prevalentHyp v.s. cigsPerDay", 
       x = "cigsPerDay", y = "prevalentHyp") 
```
### Comment: the side-byside box plot shows that there is slight difference in risk between those intake cigs or not, and there are many outliers existed in the boxplot, which could influence the accuracy of prediction, so we should not consider cigsPerDay as a valid predictor.

### Logit plot
```{r}
emplogit(y = framingham$prevalentHyp, x = framingham$cigsPerDay, binsize = 100, 
         xlab = "cigsPerDay", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is no linear relation between the cigsPerDay and TenYearCHD, according to the analysis with side by side box plot, this variable should be dropped from the model.

### Compare the BPMeds and prevalentHyp
```{r}
table1<-table(framingham$prevalentHyp, framingham$BPMeds)
mosaicplot(table1, xlab="BPMeds ", ylab="prevalentHyp")
```
### Comment: the mosaic plot shows that two proportions have relatively small difference, so BPMeds only have a very weak relation with TenYearCHD. For simplicity, we drop this variable.

### Compare TenYearCHD and prevalentHyp
```{r}
table1<-table(framingham$prevalentHyp, framingham$TenYearCHD)
mosaicplot(table1, xlab="TenYearCHD", ylab="prevalentHyp")
```
### The mosaic plot shows evident difference in proportion between two different outcomes of TenYearCHD, so we believe there is a relation between prevalentHyp and TenYearCHD. Therefore, we should add the TenYearCHD as a predictor in our model.

### Compare diabetes and prevalentHyp
```{r}
table1<-table(framingham$TenYearCHD, framingham$diabetes)
mosaicplot(table1, xlab="diabetes ", ylab=" TenYearCHD")
```
### Comment: the mosaic plot shows that there is a slight difference in proportion, indicating that there is a weak relation between diabetes and prevalentHyp. For simplicity consideration, we drop the variable

```{r}
ggplot(framingham, aes(x = totChol, y = as.factor(prevalentHyp)) )+ 
  geom_boxplot() + 
  labs(title = "prevalentHyp v.s. totChol", 
       x = "totChol", y = "prevalentHyp") 
```
### Comment: the side-byside box plot shows that those who have CHD have slightly higher average total Cholestrol level than those who is not, so there is a relatively weak relation between the TenYearCHD and totChol. We should not conclude that totChol is a valid predictor.

### Logit plot
```{r}
emplogit(y = framingham$prevalentHyp, x = framingham$totChol, binsize = 200, 
         xlab = "totChol", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is a linear relation between the prevalentHyp and totChol. However, this linear relation is weak according to the side-by-side boxplot analysis above, we should not include totChol as one of our predictors.

### Compare the sysBP and prevalentHyp
```{r}
ggplot(framingham, aes(x = sysBP, y = as.factor(TenYearCHD)) )+ 
  geom_boxplot() + 
  labs(title = "prevalentHyp v.s. sysBP", 
       x = "sysBP", y = "prevalentHyp") 
```
### Comment: the side-byside box plot shows that the systolic blood pressure is evidently higher for those who has hupertensive than not, so there is a moderate relation between the sysBP and prevalentHyp.

### Logit plot
```{r}
emplogit(y = framingham$prevalentHyp, x = framingham$sysBP, binsize = 100, 
         xlab = "sysBP", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is a linear relation between the sysBP and TenYearCHD, so no transformation needed. Therefore, the variable age should be added in the model.Notifying that there is an outlier on the lower left of the empirical logit plot, but most of the data attach with the reference line, so we should believe that there is a linear relation between sysBP and empirical logit.

### After transformation
```{r}
emplogit(y = framingham$prevalentHyp, x = log(framingham$sysBP), binsize = 100, 
         xlab = "sysBP", 
         ylab = "Empirical logit")
```

### Compare the diaBP and prevalentHyp
```{r}
ggplot(framingham, aes(x = diaBP, y = as.factor(prevalentHyp)) )+ 
  geom_boxplot() + 
  labs(title = "prevalentHyp v.s. diaBP", 
       x = "diaBP", y = "prevalentHyp") 
```
### Comment: the side-byside box plot shows that the diastolic blood pressure is evidently higher for those who has hypertensive than those not, so there is a relatively strong relation between the diaBP and prevalentHyp.

### Logit plot
```{r}
emplogit(y = framingham$prevalentHyp, x = framingham$diaBP, binsize = 200, 
         xlab = "diaBP", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is a linear relation between the diaBP and prevalentHyp, so no transformation needed. Therefore, the variable age should be added in the model. There is no obvious outliers in the plot which could impact the slope significantly, so we should stick with our conclusion.

### Compare BMI and prevalentHyp
```{r}
ggplot(framingham, aes(x = BMI, y = as.factor(prevalentHyp)) )+ 
  geom_boxplot() + 
  labs(title = "prevalentHyp v.s. BMI", 
       x = "BMI", y = "prevalentHyp") 
```
### Comment: the side-byside box plot shows that the BMI is higher for those who has hypertensive than not, so there is a moderate relation between the BMI and prevalentHyp.

### Logit plot
```{r}
emplogit(y = framingham$prevalentHyp, x = framingham$BMI, binsize = 200, 
         xlab = "BMI", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is a moderate linear relation between the BMI and TenYearCHD, so no transformation needed. Therefore, the variable age should be added in the model. Notifying that there is an outlier on the upper right cornor of the logit plot, but it was close to the reference line, indicating that it has relatively small influence to the line. Therefore, we should be confident that there is a linear relation.

### Compare heartRate and TenYearCHD
```{r}
ggplot(framingham, aes(x = heartRate, y = as.factor(TenYearCHD)) )+ 
  geom_boxplot() + 
  labs(title = "TenYearCHD v.s. heartRate", 
       x = "heartRate", y = "TenYearCHD") 
```
### Comment: the side-byside box plot shows that the heart rate is roughly the same for those who has high risk of ten year risk of CHD and not, so there is no relation between the heart rate and TenYearCHD.

### Logit plot
```{r}
emplogit(y = framingham$TenYearCHD, x = framingham$heartRate, binsize = 100, 
         xlab = "heartRate", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is very weak linear relation between the age and TenYearCHD, according to the analysis with side by side box plot, this variable should be dropped from the model.

### Compare glucose and TenYearCHD
```{r}
ggplot(framingham, aes(x = glucose, y = as.factor(TenYearCHD)) )+ 
  geom_boxplot() + 
  labs(title = "TenYearCHD v.s. glucose", 
       x = "glucose", y = "TenYearCHD") 
```
### Comment: the side-byside box plot shows that the glucose level is slightly higher for those who has high risk of ten year risk of CHD than not, so there is a moderately weak relation between the glucose level and TenYearCHD. For simplicity consideration, we drop this variable.

### Logit plot
```{r}
emplogit(y = framingham$TenYearCHD, x = framingham$glucose, binsize = 100, 
         xlab = "glucose", 
         ylab = "Empirical logit")
```
### The logit plot shows that there is very weak linear relation between the glucose and TenYearCHD once the outlier on the upper right cornor of the logit plot is dropped, according to the analysis with side by side box plot, this variable should be dropped from the model.


# Multicollinearity
### In the Part 1, we conduct EDA to check if the potential predictors have moderate/strong linear relationship with the response variable. We have found five predictors have strong/moderate linear relationship with the TenYearCHD. in this part, we will examine if there is multicollinearity between each predictors. We will use the correlation matrix for numerical-numerical variables, side-byside box plot & simple logistic models for categorical numerical variables, and mosaic plot for categorical-categorical variables.

### Section 1: multicollinearity between numerical-numerical predictors
### Correlation matrix
```{r}
cc <- cor(na.omit(framingham[, c("age", "diaBP", "BMI")]))
cc
```
### From the correlation matrix, we see that there is no numerical variables which has correlation larger than 0.5 with other numerical variables, so there is no need to add any interation terms between numerical variables.

From the correlation matrix, we see that diaBP and sysBP have about 0.7867 correlation, which is larger than 0.5. This means there is a linear relationship exist between the diaBP and sysBP. Therefore, we should add an interaction term between diaBP and sysBP (diaBP * sysBP).

### Section 2: multicollinearity between categorical-numerical predictors
### There are two categorical predictor: currentSmoker, TenYearCHD

### CurrentSmoker
### Compare currentSmoker and age
```{r}
ggplot(framingham, aes(x = age, y = as.factor(currentSmoker)) )+ 
  geom_boxplot() + 
  labs(title = "age v.s. currentSmoker", 
       x = "age", y = "currentSmoker") 
```
### The side-by-side boxplot shows that the average age of patient who is currently a smoker are evidently larger than the average age of patient who is not a smoker. Therefore, there is a relation between the age and currentSmoker, and we should add an interaction term for this. 

### simple logistic model for further analysis
```{r}
ca <- glm(currentSmoker ~ age, data = framingham, family = "binomial")
summary(ca)
```
### The P-value of the age is less than 2e-16, indicating that there is a linear relationship between the age and currentSmoker, so we should add an interaction term between these two variables.

### Compare currentSmoker and diaBP
```{r}
ggplot(framingham, aes(x = diaBP, y = as.factor(currentSmoker)) )+ 
  geom_boxplot() + 
  labs(title = "diaBP v.s. currentSmoker", 
       x = "diaBP", y = "currentSmoker") 
```
### The side-by-side boxplot shows that the average diaBP level of patient with hypertensive are slighly differs from the average cholestrol level of patient without hypertensive. Therefore, there is an ignoriable relation between the totChol and prevalentHype, and we should not add an interaction term for this. 

```{r}
ct <- glm(prevalentHyp ~ diaBP, data = framingham, family = "binomial")
summary(ct)
```

### Compare currentSmoker and BMI
```{r}
ggplot(framingham, aes(x = BMI, y = as.factor(currentSmoker)) )+ 
  geom_boxplot() + 
  labs(title = "BMI v.s. currentSmoker", 
       x = "BMI", y = "currentSmoker") 
```
### The side-by-side boxplot shows that the average BMI of smokers are evidently smaller than the average age of patient without hypertensive. Therefore, there is a relation between the age and prevalentHype, and we should add an interaction term for this. 

```{r}
cb <- glm(currentSmoker ~ BMI, data = framingham, family = "binomial")
summary(cb)
```

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
### TenYearCHD
### Compare prevalentHyp and diaBP
```{r}
ggplot(framingham, aes(x = diaBP, y = as.factor(prevalentHyp)) )+ 
  geom_boxplot() + 
  labs(title = "diaBP v.s. prevalentHyp", 
       x = "diaBP", y = "prevalentHyp") 
```
### The side-by-side boxplot shows that the average diastolic blood pressure of with hypertensive are evidently larger than the average diastolic blood pressure of patient without hypertensive. Therefore, there is a relation between the diastolic blood pressure and prevalentHype, and we should add an interaction term for this. 
```{r}
ym <- glm(prevalentHyp ~ diaBP, data = framingham, family = "binomial")
summary(ym)
```

### Compare prevalentHyp and diaBP
```{r}
ggplot(framingham, aes(x = BMI, y = as.factor(prevalentHyp)) )+ 
  geom_boxplot() + 
  labs(title = "BMI v.s. prevalentHyp", 
       x = "BMI", y = "prevalentHyp") 
```
### The side-by-side boxplot shows that the average BMI of patient with hypertensive are evidently larger than the average BMI of patient without hypertensive. Therefore, there is a relation between the BMI and prevalentHype, and we should add an interaction term for this. 

```{r}
yx <- glm(prevalentHyp ~ BMI, data = framingham, family = "binomial")
summary(yx)
```

### Section 3: multicollinearity between categorical-categorical predictors
### Because there is only one categorical predictor, so no need for categorical vs categorical comparison



# Model Creation
### In this part, we will create models and compare them to find the best logistic model to predict the CHD risk
### From the multicollinearity checking part, we know that there are some interaction exist between variables. However, we are wary how much would                   





the interaction impact the accuracy of the model. Since there are many interaction, we only need some of them, and, in extreme case, none of them if the interaction does not explain statistically significantly more variance (in this case, make significant reduction in the residual deviance), then none of the interaction term should be included in the model.Therefore, in this part, we will create models with no interaction term, some interaction term (By BSS), and all interaction term.

### Model 1: without interaction term
```{r}
library(bestglm)  # on doc: https://docs.google.com/document/d/1olhlLeU4fcwr87eSLtGmVexiZYM0-XHQi0jhH-t8ADA/edit#
BestModel<-model.matrix(glm(prevalentHyp ~ age + TenYearCHD + totChol + sysBP + 
                              diaBP + BMI,data=framingham, 
                            family="binomial"))
BestModelFind<-cbind(as.data.frame(BestModel[,-1]),response=framingham$prevalentHyp)
BSS<-bestglm(BestModelFind, IC = "AIC", family = binomial)
Model1 <- BSS$BestModel
summary(Model1)
```  

### Model 2: with some of the interaction (those with pronounced impact)
### We use the Best Subsset Selection (BSS) method to find the best collection of variables including the interaction term that explains largest portion of variability with least number of predictors.
```{r}
library(bestglm)  # on doc: https://docs.google.com/document/d/1olhlLeU4fcwr87eSLtGmVexiZYM0-XHQi0jhH-t8ADA/edit#
BestModel<-model.matrix(glm(TenYearCHD ~ age + prevalentHyp + totChol + sysBP + 
                              diaBP + BMI + 
                              diaBP:sysBP +
                              prevalentHyp:age +
                              prevalentHyp:totChol +
                              prevalentHyp:sysBP +
                              prevalentHyp:diaBP +
                              prevalentHyp:BMI,data=framingham, 
                            family="binomial"))
BestModelFind<-cbind(as.data.frame(BestModel[,-1]),response=framingham$TenYearCHD)
BSS<-bestglm(BestModelFind, IC = "AIC", family = binomial)
Model2 <- BSS$BestModel
summary(Model2)
```  

--> 

### Model 3
```{r}
y = framingham$TenYearCHD
Model3<-glm(y ~ age + prevalentHyp + totChol + sysBP + diaBP + BMI + 
                              diaBP:sysBP +
                              prevalentHyp:age +
                              prevalentHyp:totChol +
                              prevalentHyp:sysBP +
                              prevalentHyp:diaBP +
                              prevalentHyp:BMI 
                              ,data=framingham, family = "binomial")
summary(Model3)
```

### Compare 3 models
```{r}
anova(Model1, Model2, Model3, test = "LR")
```
### From the likelihood ratio test, we could see that, while Model1 perform similar as Model2, Model3 has P-value of 0.0004984, indicating that Model3 explains statistically significantly more variance than the Model1 and Model2. However, considering the number of newly added predictors, our final model should be determined based on the situation. If we want a more precise one, we should use Model3, If we want to find the probability relatively quick, we should use the Model1

### In this case, we choose Model 1 as this is the easiest model that patient, regardless of their education level, could understand easily.
### Construct the confidence intervals for the slopes of variables in Model 1
```{r}
confint(Model1, level = 0.9)
```





